#!/bin/bash

set -e
export CC=gcc

echo "==> Initing Git submodules"

git submodule update --init --recursive

echo "==> Installing gem dependencies…"

bundle install --local --binstubs --path vendor/cache "$@"

echo "==> Installing required libraries…"

if [ "$(uname)" == "Darwin" ]; then
  for pkg in glib gdk-pixbuf cmake; do
    if brew list -1 | grep -q "^${pkg}\$"; then
        echo "Package '$pkg' is installed"
    else
        echo "Package '$pkg' is not installed"
        brew install $pkg
    fi
  done
  # many, many issues with dependencies on OS X: http://git.io/vnwMJ
  brew install https://raw.githubusercontent.com/Homebrew/homebrew/26d5775494b3535820c48442c23af44f72974880/Library/Formula/cairo.rb
  brew install https://raw.githubusercontent.com/Homebrew/homebrew/e8a4de3960191c5726084416a3b78c5fcd5a3b05/Library/Formula/pango.rb
  brew link gettext --force
elif [ "$(expr substr $(uname -s) 1 5)" == "Linux" ]; then
  if [ ${TRAVIS_OS_NAME:-'linux'} = 'linux' ]; then
      echo 'nothing to do!'
  else
    sudo apt-get -qq -y install bison flex libffi-dev libxml2-dev libgdk-pixbuf2.0-dev libcairo2-dev libpango1.0-dev ttf-lyx
  fi
fi
